<!DOCTYPE html">
<meta charset="utf-8" />  
<title>WIFI logger</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script language="javascript" type="text/javascript">

  var output;
  
  function init() {
    output = document.getElementById("output");
    var pre = document.createElement("pre");
    pre.style.wordWrap = "break-word";
    output.appendChild(pre);

    // console.log(window.location.host);
    // todo use window.location.hostname to access websocket
    // var wsUri = "ws://192.168.10.110/ws";
    var wsUri = "ws://" + window.location.host + "/ws";
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) }; 
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) }; 
  }

  function onOpen(evt) {
    writeToScreen("CONNECTED\n");
  }  

  function onClose(evt) {
    writeToScreen("DISCONNECTED\n"); 
  } 

  function onMessage(evt) { 
    //writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>'); 
    writeToScreen(evt.data); 
    // websocket.close(); 
   } 

  function onError(evt) { 
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  } 

  function doSend(message) {
    websocket.send(message);
  } 

  function writeToScreen(message) {
    output.childNodes[0].innerText += message;
    output.scrollTop = output.scrollHeight;
  }

  function saveLogFile() {
    var strList = new Array()
    for( var i = 0; i < output.childNodes.length; i++ )
    {
      strList.push(output.childNodes[i].innerText);
    }
    
    var strs = strList.join();
    var blob = new Blob([strs], { type: "text/plain;charset=utf-8" });
    saveAs(blob, "log.log");
  }

  function cleareLog() {
    output.childNodes[0].innerText = ""
  }

  function preventDefaultKeys(event) {
    if((event.code === 'Space') || (event.code === 'Enter') || (event.code === 'KeyR')) {
      event.preventDefault();
    }
  }

  window.addEventListener("load", init, false);

  window.onkeydown = (e) => {
    preventDefaultKeys(e);

    if(e.key.length != 1)
    {
      switch(e.key)
      {
        case 'Enter':
          doSend('\n');
          return;
        default:
          return;
      }
    }
    var ctrlKey = '\0';
    switch(e.key)
    {
      case 'c':
        ctrlKey = String.fromCharCode(3);
        break;
      case 'r':
        ctrlKey = String.fromCharCode(18);
        break;
      case 'v':
        ctrlKey = String.fromCharCode(22);
        break;
      default:
        break;
    }

    if((e.ctrlKey == true) && (ctrlKey != '\0'))
    {
      doSend(ctrlKey);
    }
    else
    {
      doSend(e.key);
    }
  }
  
  window.onkeyup = (e) => {
    preventDefaultKeys(e);
  }

  window.addEventListener("unload", function () {
    if(websocket.readyState == WebSocket.OPEN)
        websocket.close();
    });

</script>

<h2 style="height: 22px">Debug Console</h2>

<body style="overflow-y:auto">
  <button type="button" onclick="saveLogFile()" style="height: 22px">Save Log</button>
  <button type="button" onclick="cleareLog()" style="height: 22px">Cleare Log</button>
  <div id="output" style="overflow-y:auto; overflow-x:hidden; width:100%; height: calc(100% - 80px); border: 1px solid; margin-top: 10px;"></div>
</body>

</html>